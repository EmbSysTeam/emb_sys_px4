# UART

[UART](https://en.wikipedia.org/wiki/Universal_asynchronous_receiver-transmitter) 即通用异步收发器，是一种串行、异步、全双工的通信协议。在串行通信中，数据通过单条线路或导线逐位传输。在双向通信中，使用两根导线来进行连续的串行数据传输。根据应用和系统要求，串行通信需要的电路和导线较少，可降低实现成本。

UART是一种硬件通信协议，以配置的速度使用异步串行通信，异步意味着没有时钟信号来同步从发送设备进入接收端的输出位。对于UART和大多数串行通信，发送和接收设备需要将波特率设置为相同的值。波特率是指信息传输到信道的速率。对于串行端口，设定的波特率将用作每秒传输的最大位数。

## 接口

- **RX**
  接收端

- **TX**
  发送端

## 数据传输

![dataframe | 400](asset/Pasted%20image%2020230630233340.png)

在UART中，传输模式为数据包形式。连接发送器和接收器的机制包括串行数据包的创建和物理硬件线路的控制。数据包由起始位、数据帧、奇偶校验位和停止位组成。

- **起始位**
  当不传输数据时，UART数据传输线通常保持高电压电平。若要开始数据传输，发送UART会将传输线从高电平拉到低电平并保持1个时钟周期。当接收UART检测到高到低电压跃迁时，便开始以波特率对应的频率读取数据帧中的位。

- **数据帧**
  数据帧包含所传输的实际数据。如果使用奇偶校验位，数据帧长度可以是5位到8位。如果不使用奇偶校验位，数据帧长度可以是9位。在大多数情况下，数据以最低有效位优先方式发送。

- **奇偶校验**
  奇偶性描述数据位1的个数是偶数还是奇数。通过奇偶校验位，接收UART判断传输期间是否有数据发生改变。电磁辐射、不一致的波特率或长距离数据传输都可能改变数据位。
	- 如果奇偶校验位为0（偶校验），则数据帧中的1或逻辑高位总计应为偶数。
	- 如果奇偶校验位为1（奇校验），则数据帧中的1或逻辑高位总计应为奇数。
  还可以设定为：
	- no parity：无校验 。
	- mark parity：始终为1。
	- parity：校验位始终为0。

- **停止位**
  为了表示数据包结束，发送UART将数据传输线从低电压驱动到高电压并保持1到2位时间。

数据传输时，UART会根据配置添加起始位、校验位、停止位，将并行的数据转换为串行的数据，按照设定的波特率发送出去。

# SPI

[SPI](https://en.wikipedia.org/wiki/Serial_Peripheral_Interface) 即串行外设接口，是一种同步串行通信接口规范，主要用于短距离通信。

SPI 使用主从架构以全双工模式进行通信，主机是控制设备（通常是微控制器），而从机（通常是传感器，显示器或存储芯片）。通过单独片选（CS）信号，或从选（SS）信号，支持多个从设备。理论上，从设备无上限；实际上，从机的数量受系统负载电容的限制，它会降低主机在电压电平之间准确切换的能力。

## 接口

![](asset/Pasted%20image%2020230630235247.png)

SPI被称为四线串行总线，指定四个逻辑信号：

- **SCLK**（Clock） ： 串行时钟（从主站输出）。
	每个时钟周期传输一位数据，因此数据传输的速度取决于时钟信号的频率。时钟信号由于是主机配置生成的，因此SPI通信始终由主机启动。 设备共享时钟信号的任何通信协议都称为同步。SPI是一种同步通信协议，还有一些异步通信不使用时钟信号。例如在UART通信中，双方都设置为预先配置的波特率，该波特率决定了数据传输的速度和时序。

- **MOSI**（Master Output/Slave Input） ： 主输出从输入（主站的数据输出）。
	- 或者SDI（串行数据输入）。
- **MISO**（Master Input/Slave Output）：主从输出（从站输出数据）。
	- 或者SDO（串行数据输出）。
	主机通过MOSI以串行方式将数据发送给从机，从机也可以通过MISO将数据发送给主机，两者可以同时进行。

- **SS**（Slave Select）：从选择（通常为低电平有效，从主站输出以指示正在发送数据）。
	- 或者CS（Chip Select片选）。
	主机通过拉低从机的CS/SS来使能通信。 在空闲/非传输状态下，片选线保持高电平。在主机上可以存在多个CS/SS引脚，允许主机与多个不同的从机进行通讯。

## 数据传输

![](asset/Pasted%20image%2020230701002231.png)

1. 主设备使用从器件支持的频率输出时钟。
2. 主设备拉低 SS/CS 引脚，选择逻辑电平为0的从器件。
3. 在每个SPI时钟周期内，都会发生全双工数据传输。主设备在MOSI线路上发送一个位，从机读取它，而从设备在MISO线路上发送一个位，主机读取它。
5. 传输的主设备和从设备上的两个给定字大小的移位寄存器构成一个环形缓冲器，每个时钟边沿都移出一位。传输可以持续任意数量的时钟周期。
6. 完成后，主机停止输出时钟信号，取消片选信号。

## 典型配置

1. **独立从配置**

![](asset/Pasted%20image%2020230701002902.png)

每个从机都有一个独立的片选线。主控一次只能片选一个从机。

2. **菊花链配置**

![](asset/Pasted%20image%2020230701003008.png)

将从机的MOSI和MISO链式连接，第一从机输出连接到第二从机输入等，以此类推。每个从机在下一个时钟周期内将输入复制到输出，直到低电平有效SS信号变为高电平。这种配置只需要一条主设备的SS线。

# I2C

[I2C](https://en.wikipedia.org/wiki/I%C2%B2C) 即内部集成电路，是同步、多主/多从、分组交换、单端串行通信总线。它广泛用于在短距离板内通信中将低速外设IC连接到处理器或微控制器。是一种简单（能够仅使用两个GPIO来控制设备）、双向二线制同步串行总线。它结合了SPI和UART的优点，但是速率相对较低。

## 接口

![](asset/Pasted%20image%2020230701004720.png)

仅使用两条数据线：

- **SDA** 串行数据线

- **SCL** 串行时钟线

## 数据传输

![](asset/Pasted%20image%2020230701005045.png)

I2C 数据传输使用了分组交换，数据以多个Message形式传输，每个Message都包含了从机的地址帧和多个数据帧。读写位和数据帧之间还有ACK/NACK位。

1. 启动条件：当SCL是高电平时，SDA从高电平向低电平切换。
2. 地址帧：每个从属设备唯一的7位（128个地址）或10位（1024个地址）序列，用于主从设备之间的地址识别。每个从机将其与自己的地址进行比较，如果地址匹配，它将向主机发送一个低电平ACK位。如果不匹配，则不执行任何操作，SDA线保持高电平。
3. 读/写位：地址帧的末尾包含一个读/写位。如果主机是向从机发送数据则为低电平，请求数据则为高电平。
4. ACK/NACK：消息中的每个帧后均带有一个ACK/NACK位。如果成功接收到地址帧或数据帧，接收设备会返回一个ACK位用于表示确认。
5. 数据帧：始终为8位，每个数据帧后紧跟一个ACK / NACK位进行确认。
6. 停止条件：当SCL是高电平时，SDA由低电平向高电平切换。

多主多从通信可以通过SDA信号线的高低电平来检测是否有其他主机在通信，如果SDA为低电平则表明有其他主机在控制总线。多个从机连接需要上拉SDA和SCL。

# CAN

[CAN](https://en.wikipedia.org/wiki/CAN_bus) 控制器局域网是一种车辆总线标准，CAN总线是一种多主控（Multi-Master）的总线系统，是一种基于消息的协议。具有高速连接（10Mbit/s）和长距离传输（1KM）的特点。

CAN网络的消息是广播式的，帧由所有设备接收，包括由发送设备接收。对于每个设备，帧中的数据以串行方式传输，但如果多个设备同时传输，则优先级最高的设备可以继续，而其他设备则退出。

CAN总线协议与网络协议类似，包括物理层（定义电气特性）、**传输层**（消息确认、仲裁、验证、错误检测，路由等）、对象层、应用层等。

> [!tip] UAVCAN
> 
> [UAVCAN](https://en.wikipedia.org/wiki/Cyphal)是通过CAN总线为无人机提供可靠通信的方法，是采用了与标准CAN Bus不同消息帧格式的一种CAN。

## 基本帧结构

![](asset/Pasted%20image%2020230701012613.png)

（看一眼，搬不动了，看wiki吧）

# PX4 常用设备驱动分类

> [!todo]

